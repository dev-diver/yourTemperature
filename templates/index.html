<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <title>너의 온도는</title>

    <script>
        let user;
        let votes;  //처음에 가져오는 투표결과들
        let uploadImageState = 'none' //아무것도 없을 때 이미지 상태
        let voteState = 'none'

        $(document).ready(function () {
            let user = $.cookie('user')
            showState();

            $('#setForm').on('submit', function(e) {
                e.preventDefault();  // Prevents the form from submitting the traditional way
                let temperature = $('#temperature').val();
                changeTemperature(temperature);
            });

            $('#msgInputPop').on('submit', function(e) {
                e.preventDefault();  // Prevents the form from submitting the traditional way
                let message = $('#message').val();
                updateState(voteState, message)
            });

            $(document).on('mouseenter', '.profile-container', function(){
                $(this).find('.message').css('display','block')
            }).on('mouseleave', '.profile-container', function(){
                $(this).find('.message').css('display','none')
            });
        });

        

        function showState() {
            $.ajax({
                type: "GET",
                url: "/api/votes",
                data: {},
                success: function (response) {
                    votes = response
                    show_profile('hot')
                    show_profile('good')
                    show_profile('cold')
                    show_climate(votes['most'])
                }
            })
        }
        function show_profile(state) {
            for (let i = 0; i < votes[state].length; i++) {
                url = votes[state][i]['img_url']
                stateMsg ={
                    'hot' : '추웡',
                    'good' : '좋앙',
                    'cold' : '더웡'
                }
                voteMsg = votes[state][i]['message']
                message = voteMsg=="" ? stateMsg[state]:voteMsg
                console.log(voteMsg,stateMsg[state])
                html_template = `
                    <div class="profile-container">
                        <img class="profile" src=${url}>
                        <span class="message hide">${message}</span>
                    </div>
                `
                $(`#${state} > .profiles`).append(html_template);
            }

        }
        function show_climate(state) {
            $.ajax({
                type : "GET",
                url : "/api/stateImages",
                data : {'state' : state },
                success : function(response){
                    img_url = response['image_url']
                    const imageElement = document.getElementById('climateImage');
                    imageElement.src = img_url;                
                }
            })
        }
        // 상태 업데이트 함수
        function updateState(newState) {
            $.ajax({
                type: 'POST',
                url: '/api/vote',
                data: JSON.stringify({ "state": newState , "email" : user['email'] }),
                contentType: 'application/json',
                success: function (response) {
                    if (response['result'] == 'success') {
                        alert('투표 완료')
                        window.location.reload()                       
                    }
                }
            });
        }

        function uploadFile() {
            var formData = new FormData($('#uploadForm')[0]);
            formData.append('email',user['email'])
            formData.append('state',uploadImageState)
            console.log("전송", formData)
            $.ajax({
                url: '/api/uploadImage',
                type: 'POST',
                data: formData,
                processData: false, // 중요: 이 설정을 통해 jQuery가 데이터를 쿼리 문자열로 변환하는 것을 방지합니다.
                contentType: false, // 중요: FormData를 사용할 때는 'multipart/form-data'로 설정하되, 자동 생성되도록 둡니다.
                success: function (response) {
                    console.log('File uploaded successfully:', response);
                    alert("업로드 성공 !!")
                },
                error: function (jqXHR, textStatus, errorMessage) {
                    console.log('Error uploading file:', errorMessage);
                    alert("업로드 실패 !!")
                }
            });
            hidePop()
        }

        function changeTemperature(temperature){
            $.ajax({
                type: 'POST',
                url: '/api/set',
                data: {
                    "email" : user['email'],
                    "temperature": temperature
                },
                contentType: 'application/json',
                success: function (response) {
                    if (response['result'] == 'success') {
                        alert('설정 완료')
                        window.location.reload()                       
                    }
                }
            });
        }

        function handleFileSelect(state) {
            uploadImageState = state
            console.log(uploadImageState)
            $('#uploadForm').css('display', 'block');
        }

        function showPop() {
            var pop = document.getElementById('climatePop');
            pop.style.display = 'block'; // 요소를 보이게 만듭니다.
            uploadImageState = 'none'
            $('#uploadForm').css('display', 'none');
        }

        function hidePop() {
            var pop = document.getElementById('climatePop');
            pop.style.display = 'none'; // 요소를 숨깁니다
        }

        function showSet() {
            $('#setPop').css('display','block')
        }

        function hideSet() {
            $('#setPop').css('display','none')
        }

        function showMsgInput(state){
            let voteState = state
            $('#msgInputPop').css('display','block')
        }

        function hideMsgInput(){
            $('#msgInputPop').css('display','none')
        }

    </script>

    <style>
        #container {
            width: 400px;
            margin: 0 auto;
            text-align: center;
            position:relative;
        }

        #climateImage {
            width: 400px;
        }

        .upload {
            border: 2px solid #000;
            padding: 5px;
            width: 150px;
            text-align: center;
        }

        .popup {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            height: 20%; /* or whatever height you desire */
            width: 70%;  /* or whatever width you desire */
            margin: auto;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            display: none;
        }

        .votes {
            display: flex;
            flex-direction: row;
        }
        
        .vote {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;  /* Optional: To center align items vertically */
        }

        .profile {
            width:30px;
        }

        .hide {
            display: none;
        }

    </style>
</head>

<body>
    <div id="container">
        <h2>현재 정글의 기상상태</h2>
        <div>
            <img id="climateImage" src="" alt="">
        </div>
        <button onclick="showSet()">바꿨음</button>
        <button onclick="showPop()">[+]</button>
        <br>
        <div class="votes">
            <div id="hot" class="vote">
                <button id="hotButton" onclick="showMsgInput('hot')">Hot</button>
                <div class ="profiles">
                </div>
            </div>
            <div id="good" class="vote">
                <button id="goodButton" onclick="showMsgInput('good')">Good</button>
                <div class ="profiles">
                </div>
            </div>
            <div id="cold" class="vote">
                <button id="coldButton" onclick="showMsgInput('cold')">Cold</button>
                <div class ="profiles">
                </div>
            </div>
        </div>
        <div id="climatePop" class="popup">
            <div>
                <button onclick="hidePop()">닫기</button>
            </div>
            <button onClick="handleFileSelect('hot')">HOT</button>
            <button onClick="handleFileSelect('good')">GOOD</button>
            <button onClick="handleFileSelect('none')">COLD</button>
            <form id="uploadForm" enctype="multipart/form-data">
                <input type="file" id="imageFile" name="file">
                <input type="button" value="Upload" onclick="uploadFile()">
            </form>
        </div>
        <div id="setPop" class="popup">
            <div>
                <button onclick="hideSet()">닫기</button>
            </div>
            <form id="setForm">
                <label for="temperature">설정 온도:</label>
                <input type="number" id="temperature" name="temperature" required>
                <input type="submit" value="바꿈!">
            </form>
        </div>
        <div id="msgInputPop" class="popup">
            <div>
                <button onclick="hideMsgInput()">닫기</button>
            </div>
            <form id="setForm">
                <label for="temperature">메시지:</label>
                <input type="text" id="message" name="message" placeholder="">
                <input type="submit" value="투표">
            </form>
        </div>
    </div>

</body>

</html>