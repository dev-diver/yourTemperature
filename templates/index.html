<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <title>너의 온도는</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">


    <script>
        let token;
        let user;
        let votes;  //처음에 가져오는 투표결과들
        let uploadImageState = 'none' //아무것도 없을 때 이미지 상태
        let voteState = 'none'
        stateMsg = {
            'hot': '더워요',
            'good': '적당해요',
            'cold': '추워요'
        }
        stateCuteMsg = {
            'hot': '더웡',
            'good': '좋앙',
            'cold': '추웡'
        }

        $(document).ready(function () {
            token = $.cookie('token')
            user = JSON.parse($.cookie('user'))
            console.log(user)
            console.log(user['email'], user['nickname'])
            showState();

            $('#setForm').on('submit', function (e) {
                e.preventDefault();  // Prevents the form from submitting the traditional way
                let temperature = $('#temperature').val();
                changeTemperature(temperature);
            });

            $('#msgInputPop').on('submit', function (e) {
                e.preventDefault();  // Prevents the form from submitting the traditional way
                let message = $('#message').val();
                updateState(voteState, message)
            });

            $(document).on('mouseenter', '.profile-container', function () {
                $(this).find('.message').css('display', 'block')
            }).on('mouseleave', '.profile-container', function () {
                $(this).find('.message').css('display', 'none')
            });
        });

        function logout() {
            $.removeCookie('user');
            $.removeCookie('token');
            window.location.href = "/login"
        }

        function showState() {
            $.ajax({
                type: "GET",
                url: "/api/votes",
                data: {},
                success: function (response) {
                    votes = response
                    show_profile('hot')
                    show_profile('good')
                    show_profile('cold')
                    show_climate(votes['most'])
                    showStateMessage()
                }
            })
        }

        function showStateMessage() {
            let most = votes['most']
            let messages = votes[most]
            var randomIndex = Math.floor(Math.random() * messages.length);
            let message = messages[randomIndex]['message']
            message = message != '' ? message : stateMsg[most]
            $('#climateMessage').text(`[${message}]`)
        }

        function show_profile(state) {
            console.log(votes)
            for (let i = 0; i < votes[state].length; i++) {
                url = votes[state][i]['img_url']
                voteMsg = votes[state][i]['message']
                message = voteMsg == "" ? stateCuteMsg[state] : voteMsg
                console.log(voteMsg, stateMsg[state])
                html_template = `
                    <div class="profile-container column is-6">
                        <img class="profile" src=${url}>
                        <span class="message hide">${message}</span>
                    </div>
                `
                row = parseInt(i / 2)
                mod = i % 2
                console.log(row, mod)
                if (mod == 0) {
                    $(`#${state} > .profiles`).append(`<div id=${state}${row} class="columns row"></div>`)
                }
                $(`#${state}${row}`).append(html_template);
            }

        }
        function show_climate(state) {
            $.ajax({
                type: "GET",
                url: "/api/stateImages",
                data: { 'state': state },
                success: function (response) {
                    img_url = response['image_url']
                    const imageElement = document.getElementById('climateImage');
                    imageElement.src = img_url;
                }
            })
        }
        // 상태 업데이트 함수
        function updateState(newState) {
            $.ajax({
                type: 'POST',
                url: '/api/vote',
                data: JSON.stringify({ "state": newState, "email": user['email'] }),
                contentType: 'application/json',
                success: function (response) {
                    if (response['result'] == 'success') {
                        alert('투표 완료')
                        window.location.reload()
                    }
                }
            });
        }

        function uploadFile() {
            var formData = new FormData($('#uploadForm')[0]);
            formData.append('email', user['email'])
            formData.append('state', uploadImageState)
            console.log("전송", formData)
            $.ajax({
                url: '/api/uploadImage',
                type: 'POST',
                data: formData,
                processData: false, // 중요: 이 설정을 통해 jQuery가 데이터를 쿼리 문자열로 변환하는 것을 방지합니다.
                contentType: false, // 중요: FormData를 사용할 때는 'multipart/form-data'로 설정하되, 자동 생성되도록 둡니다.
                success: function (response) {
                    console.log('File uploaded successfully:', response);
                    alert("업로드 성공 !!")
                },
                error: function (jqXHR, textStatus, errorMessage) {
                    console.log('Error uploading file:', errorMessage);
                    alert("업로드 실패 !!")
                }
            });
            hidePop()
        }

        function changeTemperature(temperature) {
            console.log(user)
            $.ajax({
                type: 'POST',
                url: '/api/set',
                data: {
                    "email": user['email'],
                    "temperature": temperature
                },
                contentType: 'application/json',
                success: function (response) {
                    if (response['result'] == 'success') {
                        alert('설정 완료')
                        window.location.reload()
                    }
                }
            });
        }

        function handleFileSelect(state) {
            uploadImageState = state
            console.log(uploadImageState)
            $('#uploadForm').css('display', 'block');
        }

        function showPop() {
            var pop = document.getElementById('climatePop');
            pop.style.display = 'block'; // 요소를 보이게 만듭니다.
            uploadImageState = 'none'
            $('#uploadForm').css('display', 'none');
        }

        function hidePop() {
            var pop = document.getElementById('climatePop');
            pop.style.display = 'none'; // 요소를 숨깁니다
        }

        function showSet() {
            $('#setPop').css('display', 'block')
        }

        function hideSet() {
            $('#setPop').css('display', 'none')
        }

        function showMsgInput(state) {
            let voteState = state
            $('#msgInputPop').css('display', 'block')
        }

        function hideMsgInput() {
            $('#msgInputPop').css('display', 'none')
        }

    </script>

    <style>
        .container {
            width: 400px;
            margin: 0 auto;
            text-align: center;
            position: relative;
        }

        #climateImage {
            width: 400px;
        }

        .upload {
            border: 2px solid #000;
            padding: 5px;
            width: 150px;
            text-align: center;
        }

        .popup {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            height: 20%;
            /* or whatever height you desire */
            width: 100%;
            /* or whatever width you desire */
            margin: auto;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            display: none;
        }

        .votes {
            display: flex;
            flex-direction: row;
        }

        .vote {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Optional: To center align items vertically */
        }

        .row {
            padding: 0px;
            margin: 0px;
        }

        .profiles {
            margin-top: 10px;
        }

        .profile-container {
            padding: 0.5rem;
        }


        .hide {
            display: none;
        }

        /* .bulma-delete-mixin {
            @include delete;
        } */
    </style>
</head>

<body>
    <div class="container">
        <h2 class="title is-2" style="margin-top: 30px;">현재 정글의 기상상태</h2>
        <h3 class="title is-3" id="climateMessage"></h3>
        <div class="has-text-right"><button class="button" onclick="logout()">로그아웃</button></div>
        <div>
            <img id="climateImage" src="" alt="">
        </div>
        <button onclick="showSet()" class="button is-danger is-outlined">
            <span class="icon is-small">
                <ion-icon name="thermometer-outline"></ion-icon>
            </span>
            <span>온도 설정</span>
        </button>
        <button class="button is-info is-outlined" onclick="showPop()">
            <span class="icon is-small">
                <ion-icon name="cloud-upload-outline"></ion-icon>
            </span>
            <span>사진 업로드</span>
        </button>
        <br>
        <br>
        <br>
        <div class="columns">
            <div id="hot" class="column is-one-third">
                <button class="button is-danger is-medium" onclick="showMsgInput('hot')">Hot</button>
                <div class="profiles">
                </div>
            </div>
            <div id="good" class="column">
                <button class="button is-success is-medium" onclick="showMsgInput('good')">Good</button>
                <div class="profiles">
                </div>
            </div>
            <div id="cold" class="column ">
                <button class="button is-link is-medium" onclick="showMsgInput('cold')">Cold</button>
                <div class="profiles">
                </div>
            </div>
        </div>
        <div id="climatePop" class="popup">
            <div style="margin-bottom: 5px; text-align: right ;">
                <button onclick="hidePop()" class="bulma-delete-mixin is-small"></button>
            </div>
            <div style="margin-bottom: 20px;">
                <button class="button is-danger is-small" onClick="handleFileSelect('hot')">HOT</button>
                <button class="button is-success is-small" onClick="handleFileSelect('good')">GOOD</button>
                <button class="button is-link is-small" onClick="handleFileSelect('none')">COLD</button>
            </div>
            
            <div class="columns">
            <form id="uploadForm" class="column is-10 file has-name is-fullwidth is-small" enctype="multipart/form-data">
                <label class="file-label ">
                    <input id ="imageFile" class="file-input" type="file" name="file">
                    <span class="file-cta">
                      <span class="file-icon">
                        <i class="fas fa-upload"></i>
                      </span>
                      <span class="file-label">
                        Choose a file…
                      </span>
                    </span>
                    <span class="file-name">
                      
                    </span>
                  </label>
                
                </form>
                <input type="button" value="Upload" onclick="uploadFile()">
            </div>
            
        </div>
        <div id="setPop" class="popup">
            <div style="text-align: right;">
                <button onclick="hideSet()" class="button"><ion-icon name="close-outline" size="large"
                        style="color: red;""></ion-icon></button>
            </div>
            <div style=" text-align: center;">
                        <form id="setForm">
                            <label for="temperature"><strong style="color: white;">설정 온도:</strong></label>
                            <input class="input is-small" type="number" id="temperature" name="temperature" required
                                style="width: 60px;">
                            <input type="submit" value="바꿈!">
                        </form>
            </div>
        </div>
        <div id="msgInputPop" class="popup">
            <div>
                <button onclick="hideMsgInput()">닫기</button>
            </div>
            <form id="setForm">
                <label for="temperature">메시지:</label>
                <input type="text" id="message" name="message" placeholder="">
                <input type="submit" value="투표">
            </form>
        </div>
    </div>

    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</body>

</html>